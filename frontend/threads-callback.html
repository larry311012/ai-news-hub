<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threads OAuth - Connecting...</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 48px 40px;
            max-width: 420px;
            width: 100%;
            text-align: center;
        }

        .logo {
            width: 64px;
            height: 64px;
            margin: 0 auto 24px;
            background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo svg {
            width: 36px;
            height: 36px;
            color: white;
        }

        .spinner {
            width: 48px;
            height: 48px;
            margin: 0 auto 24px;
            border: 4px solid #f3f4f6;
            border-top-color: #8B5CF6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
        }

        p {
            font-size: 15px;
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f3f4f6;
            border-radius: 8px;
            font-size: 13px;
            color: #4b5563;
            margin-top: 16px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #8B5CF6;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .error-container {
            display: none;
        }

        .error-container.show {
            display: block;
        }

        .error-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 24px;
            background: #FEE2E2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error-icon svg {
            width: 32px;
            height: 32px;
            color: #DC2626;
        }

        .error-title {
            font-size: 20px;
            font-weight: 700;
            color: #DC2626;
            margin-bottom: 12px;
        }

        .error-message {
            color: #991B1B;
            margin-bottom: 24px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(139, 92, 246, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div id="loading-state">
            <div class="logo">
                <svg fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12.186 24h-.007c-3.581-.024-6.334-1.205-8.184-3.509C2.35 18.44 1.5 15.586 1.472 12.01v-.017c.03-3.579.879-6.43 2.525-8.482C5.845 1.205 8.6.024 12.18 0h.014c2.746.02 5.043.725 6.826 2.098 1.677 1.29 2.858 3.13 3.509 5.467l-2.04.569c-1.104-3.96-3.898-5.984-8.304-6.015-2.91.022-5.11.936-6.54 2.717C4.307 6.504 3.616 8.914 3.589 12c.027 3.086.718 5.496 2.057 7.164 1.43 1.781 3.631 2.695 6.54 2.717 2.623-.02 4.358-.631 5.8-2.045 1.647-1.613 1.618-3.593 1.09-4.798-.31-.71-.873-1.3-1.634-1.75-.192 1.352-.622 2.446-1.284 3.272-.886 1.102-2.14 1.704-3.73 1.79-1.202.065-2.361-.218-3.259-.801-1.063-.689-1.685-1.74-1.752-2.964-.065-1.19.408-2.285 1.33-3.082.88-.76 2.119-1.207 3.583-1.291a13.853 13.853 0 013.02.142l-.126 1.974a11.881 11.881 0 00-2.58-.123c-1.018.056-1.84.344-2.446.855-.583.493-.87 1.12-.834 1.814.036.683.388 1.217.99 1.502.539.255 1.277.354 2.101.28 1.15-.093 2.059-.535 2.702-1.315.646-.784.972-1.858.972-3.197V8.033c0-.458-.006-.916-.02-1.373l2.04-.057c.013.457.02.915.02 1.373v1.78c.598-.421 1.3-.758 2.092-.998 1.004-.304 2.085-.457 3.212-.457l.126 1.99c-.905 0-1.766.123-2.562.366-.796.243-1.47.6-2.004 1.062v1.304c.54.694.97 1.49 1.28 2.369.726 2.057.746 4.753-1.44 6.993-1.817 1.869-4.138 2.82-7.106 2.848z"/>
                </svg>
            </div>
            <div class="spinner"></div>
            <h1>Connecting to Threads</h1>
            <p>Please wait while we complete the authorization...</p>
            <p id="status-message" style="font-size: 13px; color: #9ca3af; margin-top: 16px;">Initializing...</p>
            <div class="status">
                <span class="status-dot"></span>
                <span>Secure OAuth Connection</span>
            </div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="error-container">
            <div class="error-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </div>
            <h1 class="error-title">Connection Failed</h1>
            <p class="error-message" id="error-message">Unable to complete Threads authorization.</p>
            <a href="profile.html" class="btn">Return to Profile</a>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8000/api';

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');
        const errorDescription = urlParams.get('error_description');

        // Update status message
        function updateStatus(message) {
            const statusEl = document.getElementById('status-message');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }

        // Show error state
        function showError(message) {
            document.getElementById('loading-state').style.display = 'none';
            const errorState = document.getElementById('error-state');
            errorState.classList.add('show');
            document.getElementById('error-message').textContent = message;
        }

        // Handle OAuth callback
        async function handleCallback() {
            try {
                // Check for errors from OAuth provider
                if (error) {
                    console.error('OAuth error:', error, errorDescription);

                    if (error === 'access_denied') {
                        notifyParent('error', 'user_denied');
                        showError('You cancelled the authorization. Please try again if you want to connect your Threads account.');
                    } else {
                        notifyParent('error', 'oauth_failed');
                        showError(errorDescription || 'Authorization failed. Please try again.');
                    }

                    // Close window after delay
                    setTimeout(() => {
                        window.close();
                    }, 3000);
                    return;
                }

                // Check if we have required parameters
                if (!code || !state) {
                    console.error('Missing required parameters:', { code: !!code, state: !!state });
                    notifyParent('error', 'invalid_callback');
                    showError('Invalid callback parameters. Please try connecting again.');

                    setTimeout(() => {
                        window.close();
                    }, 3000);
                    return;
                }

                updateStatus('Verifying authorization...');

                // Get auth token from localStorage
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    console.error('No auth token found');
                    showError('Authentication required. Please log in and try again.');

                    setTimeout(() => {
                        window.location.href = 'auth.html';
                    }, 2000);
                    return;
                }

                updateStatus('Exchanging authorization code...');

                // Complete OAuth flow on backend
                const response = await fetch(
                    `${API_BASE_URL}/social-media/threads/callback?code=${encodeURIComponent(code)}&state=${encodeURIComponent(state)}`,
                    {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );

                const data = await response.json();

                if (response.ok) {
                    updateStatus('Connection successful!');

                    // Notify parent window of success
                    notifyParent('success', null, data.username || null);

                    // Close window after short delay
                    setTimeout(() => {
                        window.close();
                    }, 1500);
                } else {
                    console.error('Callback failed:', response.status, data);

                    const errorMsg = data.detail || data.message || 'Failed to complete authorization';
                    notifyParent('error', 'oauth_failed');
                    showError(errorMsg);

                    // Close window after delay
                    setTimeout(() => {
                        window.close();
                    }, 3000);
                }

            } catch (error) {
                console.error('Error processing callback:', error);
                notifyParent('error', 'server_error');
                showError('An error occurred while connecting. Please try again.');

                // Close window after delay
                setTimeout(() => {
                    window.close();
                }, 3000);
            }
        }

        // Notify parent window via postMessage
        function notifyParent(result, errorType = null, username = null) {
            if (!window.opener) {
                console.warn('No opener window found');
                return;
            }

            const message = {
                type: result === 'success' ? 'threads-oauth-success' : 'threads-oauth-error',
                platform: 'threads',
                success: result === 'success',
                error: errorType,
                username: username
            };

            try {
                window.opener.postMessage(message, window.location.origin);
            } catch (e) {
                console.error('Failed to post message:', e);
            }
        }

        // Start the callback handling
            code: code ? 'present' : 'missing',
            state: state ? 'present' : 'missing',
            error: error || 'none'
        });

        // Handle callback
        handleCallback();
    </script>
</body>
</html>
